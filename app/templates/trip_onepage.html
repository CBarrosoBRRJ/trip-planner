{% extends "base.html" %}
{% block content %}

<div class="grid gap-6" {% if mode != "create" %}id="pageRoot" data-trip-token="{{ trip.token }}"{% endif %}>

  <!-- HEADER FIXO -->
  <div class="sticky top-0 z-20 -mx-3 px-3 backdrop-blur bg-slate-950/70 border-b border-slate-800">
    <div class="py-4 grid gap-3">

      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
        <div class="min-w-0">
          <h1 class="text-2xl font-semibold tracking-tight">
            {% if mode == "create" %}Criar viagem{% else %}{{ trip.title }}{% endif %}
          </h1>

          {% if mode != "create" %}
          <p class="text-slate-300 mt-1">
            {{ trip.destination }} ‚Ä¢ <span class="font-medium">{{ trip.start_date }}</span> ‚Üí <span class="font-medium">{{ trip.end_date }}</span> ‚Ä¢ {{ trip.currency }}
          </p>
          {% endif %}

          {% if error %}
          <div class="mt-3 rounded-2xl border border-rose-900 bg-rose-950/40 p-3 text-rose-200 text-sm">
            {{ error }}
          </div>
          {% endif %}
        </div>

        {% if mode != "create" %}
        <!-- BOX MACRO -->
        <div class="w-full lg:w-[560px] rounded-2xl border border-slate-800 bg-slate-900/30 p-4">
          <div class="grid gap-3">
            <div>
              <p class="text-sm text-slate-300">Link para compartilhar</p>
              <div class="mt-2 flex gap-2">
                <input id="shareLink" value="{{ share_url }}" readonly class="w-full field" />
                <button type="button" id="btnCopy" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                  Copiar
                </button>
              </div>
              <p id="copyMsg" class="mt-2 text-xs text-slate-400"></p>
            </div>

            <div class="flex flex-wrap gap-2">
              <a href="{{ gcal_url }}" target="_blank"
                 class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition font-medium">
                Salvar no Google Agenda
              </a>
              <button type="button" id="btnEditTrip"
                 class="px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
                Editar viagem
              </button>
            </div>

            <div id="editTripBox" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
              <p class="text-sm text-slate-300 font-semibold">Editar dados da viagem</p>
              <form method="post" action="/t/{{ trip.token }}/edit" class="mt-3 grid gap-3">
                <div class="grid md:grid-cols-2 gap-2">
                  <input name="title" value="{{ trip.title }}" class="field" required minlength="2" />
                  <input name="destination" value="{{ trip.destination }}" class="field" required minlength="2" />
                </div>
                <div class="grid md:grid-cols-3 gap-2">
                  <input type="date" name="start_date" value="{{ trip.start_date }}" class="field" required />
                  <input type="date" name="end_date" value="{{ trip.end_date }}" class="field" required />
                  <select name="currency" class="field">
                    <option value="BRL" {% if trip.currency=="BRL" %}selected{% endif %}>BRL</option>
                    <option value="USD" {% if trip.currency=="USD" %}selected{% endif %}>USD</option>
                    <option value="EUR" {% if trip.currency=="EUR" %}selected{% endif %}>EUR</option>
                  </select>
                </div>
                <button class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition font-medium">
                  Salvar altera√ß√µes
                </button>
              </form>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      {% if mode != "create" %}
      <!-- PARTICIPANTES -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
          <div>
            <p class="text-sm text-slate-300">Participantes (quem aceitou)</p>
            <p class="text-xs text-slate-400">Sem login: a pessoa preenche nome/email e aparece aqui.</p>
          </div>

          <form method="post" action="/t/{{ trip.token }}/join"
                class="grid grid-cols-1 md:grid-cols-3 gap-2 w-full lg:w-[680px]">
            <input name="name" required minlength="2" placeholder="Nome" class="field field-light" />
            <input name="email" placeholder="Email (opcional)" class="field field-light" />
            <button class="rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium px-4 py-2">
              Aceitar viagem
            </button>
          </form>
        </div>

        {% if participants and participants|length > 0 %}
        <div class="mt-3 flex flex-wrap gap-2">
          {% for p in participants %}
          <div class="px-3 py-2 rounded-2xl bg-slate-950 border border-slate-800 text-sm text-slate-200 flex items-center gap-2">
            <span class="font-medium">{{ p.name }}</span>
            {% if p.email %}<span class="text-slate-400">‚Ä¢ {{ p.email }}</span>{% endif %}
            <form method="post" action="/t/{{ trip.token }}/participants/{{ p.id }}/delete">
              <button type="submit" class="ml-2 px-2 py-1 rounded-xl bg-slate-800 hover:bg-rose-600 transition text-xs">
                remover
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- TABS -->
      <div class="flex gap-2 overflow-x-auto pb-1" id="tabs">
        <button class="tab-btn" data-tab="tab-passeios">Passeios</button>
        <button class="tab-btn" data-tab="tab-passagens">Passagens</button>
        <button class="tab-btn" data-tab="tab-hospedagens">Hospedagens</button>
        <button class="tab-btn" data-tab="tab-restaurantes">Restaurantes</button>
        <button class="tab-btn" data-tab="tab-transporte">Transporte</button>
        <button class="tab-btn" data-tab="tab-custos">Custos</button>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- BODY -->
  <div class="grid gap-6">
    {% if mode == "create" %}
      <!-- CREATE MODE -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6 max-w-3xl">
        <p class="text-slate-300">Crie e compartilhe com amigos e familiares o planejamento da sua viagem.</p>

        <form method="post" action="/t/new" class="mt-5 grid gap-4">
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300">T√≠tulo</label>
              <input name="title" required minlength="2" maxlength="120" class="mt-1 w-full field field-light" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Destino</label>
              <input name="destination" required minlength="2" maxlength="120" class="mt-1 w-full field field-light" />
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-300">In√≠cio</label>
              <input id="startDate" type="date" name="start_date" required class="mt-1 w-full field field-light" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Dura√ß√£o (dias)</label>
              <input id="durationDays" name="duration_days" inputmode="numeric" placeholder="Ex: 10" class="mt-1 w-full field field-light" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Fim (auto)</label>
              <input id="endDate" type="date" name="end_date" class="mt-1 w-full field field-light" />
              <p class="text-xs text-slate-400 mt-1">Se preencher dura√ß√£o, calculamos o fim.</p>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-300">Moeda</label>
              <select name="currency" class="mt-1 w-full field field-light">
                <option value="BRL">BRL</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
          </div>

          <button class="mt-2 px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition font-medium w-full md:w-auto">
            Criar e gerar link
          </button>
        </form>
      </div>
    {% else %}

      {% set acts = groups.get("activity", []) %}
      {% set flights = groups.get("flight", []) %}
      {% set hotels = groups.get("hotel", []) %}
      {% set rests = groups.get("restaurant", []) %}
      {% set trans = groups.get("transport", []) %}

      <!-- ===================================================== -->
      <!-- PASSEIOS -->
      <div class="tab-panel" id="tab-passeios">
        <div class="grid gap-4">

          <!-- FORM (SIM√âTRICO) -->
          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h2 class="panel-title">Passeios</h2>
                <p class="panel-sub">Crie seu roteiro. Depois, os cards ficam organizados por dia.</p>
              </div>
              <div class="badge-count">{{ acts|length }} salvos</div>
            </div>

            <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 form-grid">
              <input type="hidden" name="category" value="activity" />

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Nome da atividade</label>
                  <input name="title" class="field field-light" placeholder="Ex: Coliseu, Tour Vaticano..." required />
                </div>
                <div class="fg-col fg-2-inner">
                  <div>
                    <label class="lbl">Data</label>
                    <input type="date" name="item_date" min="{{ trip.start_date }}" max="{{ trip.end_date }}" class="field field-light" required />
                  </div>
                  <div>
                    <label class="lbl">Per√≠odo</label>
                    <select name="period" class="field field-light">
                      <option value="">Selecione</option>
                      <option>Manh√£</option><option>Tarde</option><option>Noite</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Endere√ßo</label>
                  <div class="flex gap-2">
                    <input id="addrActivity" name="address" class="field field-light w-full" placeholder="Rua, bairro, cidade..." />
                    <button type="button" class="btn-soft" onclick="openMaps('addrActivity')">Maps</button>
                  </div>
                </div>
                <div class="fg-col">
                  <label class="lbl">Opcional</label>
                  <div class="toggle-card">
                    <input type="checkbox" id="actFree" name="is_free" class="accent-indigo-500" />
                    <div>
                      <p class="font-semibold text-sm">Gratuito</p>
                      <p class="text-xs text-slate-500">Oculta custo e link</p>
                    </div>
                  </div>
                </div>
              </div>

              <div id="actPaidBox" class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Valor</label>
                  <input name="cost" class="field field-light" placeholder="Ex: 80,00" />
                </div>
                <div class="fg-col">
                  <label class="lbl">Link ingresso</label>
                  <input name="ticket_url" class="field field-light" placeholder="URL (opcional)" />
                </div>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Nota</label>
                <textarea name="notes" class="field field-light textarea-big" rows="4" placeholder="Observa√ß√µes..."></textarea>
              </div>

              <div class="flex justify-end">
                <button class="btn-primary">Salvar passeio</button>
              </div>
            </form>
          </div>

          <!-- SALVOS POR DIA -->
          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h3 class="panel-title-sm">Roteiro por dia</h3>
                <p class="panel-sub">Cada data vira uma linha. Dentro dela, cards rolam horizontalmente.</p>
              </div>
              <div class="badge-count">{{ acts|length }} itens</div>
            </div>

            {% if acts|length == 0 %}
              <div class="empty-state mt-4">
                <div class="empty-ico">üó∫Ô∏è</div>
                <div>
                  <p class="font-semibold text-slate-100">Nenhum passeio salvo</p>
                  <p class="text-slate-400 text-sm">Preencha o formul√°rio acima e comece seu roteiro.</p>
                </div>
              </div>
            {% else %}

              {% set ns = namespace(bydate={}) %}
              {% for it in acts %}
                {% set d = (it.item_date|string) %}
                {% if d in ns.bydate %}
                  {% set _ = ns.bydate[d].append(it) %}
                {% else %}
                  {% set _ = ns.bydate.update({d: [it]}) %}
                {% endif %}
              {% endfor %}

              <div class="mt-4 grid gap-4">
                {% for d, items in ns.bydate|dictsort %}
                  <div class="day-row">
                    <div class="day-head">
                      <div class="day-date">üìÖ {{ d }}</div>
                      <div class="day-count">{{ items|length }} itens</div>
                    </div>

                    <div class="strip-wrap">
                      <button type="button" class="strip-btn left" data-strip="left">‚Äπ</button>

                      <div class="strip-viewport">
                        <div class="strip" data-strip="1">
                          {% for it in items %}
                            {% set addr = it._meta.get("address","") %}
                            {% set url = (it._meta.get("ticket_url","") or it.url or "") %}
                            <button type="button"
                              class="saved-card js-open-modal"
                              data-id="{{ it.id }}"
                              data-category="{{ it.category }}"
                              data-title="{{ it.title|e }}"
                              data-date="{{ it.item_date }}"
                              data-period="{{ it._meta.get('period','')|e }}"
                              data-is-free="{{ '1' if it._meta.get('is_free') else '0' }}"
                              data-address="{{ addr|e }}"
                              data-url="{{ url|e }}"
                              data-notes="{{ it._meta.get('notes','')|e }}"
                              data-cost="{{ trip.currency }} {{ cents_to_money(it.cost) if it.cost is not none else '' }}"
                            >
                              <div class="saved-map">
                                {% if addr %}
                                  <iframe
                                    class="saved-iframe js-lazy-map"
                                    loading="lazy"
                                    referrerpolicy="no-referrer-when-downgrade"
                                    data-src="https://www.google.com/maps?q={{ addr|urlencode }}&output=embed"></iframe>
                                {% else %}
                                  <div class="saved-map-fallback">
                                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                                  </div>
                                {% endif %}
                                <div class="saved-gradient"></div>
                              </div>

                              <div class="saved-body">
                                <div class="flex items-start justify-between gap-2">
                                  <p class="saved-title">{{ it.title }}</p>
                                  {% if it.cost is not none %}
                                    <span class="saved-cost">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>
                                  {% endif %}
                                </div>

                                <div class="saved-meta">
                                  {% if it._meta.get("period") %}<span class="tag">üïí {{ it._meta.get("period") }}</span>{% endif %}
                                  {% if it._meta.get("is_free") %}<span class="tag">üÜì Gratuito</span>{% endif %}
                                </div>

                                {% if addr %}
                                  <p class="saved-addr">{{ addr }}</p>
                                {% else %}
                                  <p class="saved-addr muted">Sem endere√ßo</p>
                                {% endif %}

                                <div class="saved-actions-hint">
                                  <span class="hint-pill">Exibir</span>
                                  {% if url %}<span class="hint-pill">Link</span>{% endif %}
                                </div>
                              </div>
                            </button>
                          {% endfor %}
                        </div>
                      </div>

                      <button type="button" class="strip-btn right" data-strip="right">‚Ä∫</button>
                    </div>
                  </div>
                {% endfor %}
              </div>

            {% endif %}
          </div>

        </div>
      </div>

      <!-- ===================================================== -->
      <!-- PASSAGENS -->
      <div class="tab-panel" id="tab-passagens">
        <div class="grid gap-4">

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h2 class="panel-title">Passagens</h2>
                <p class="panel-sub">Organize voos por data (cada data vira uma linha abaixo).</p>
              </div>
              <div class="badge-count">{{ flights|length }} salvos</div>
            </div>

            <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 form-grid">
              <input type="hidden" name="category" value="flight" />

              <div class="fg fg-3">
                <div class="fg-col">
                  <label class="lbl">Data</label>
                  <input type="date" name="item_date" min="{{ trip.start_date }}" max="{{ trip.end_date }}" class="field field-light" required />
                </div>
                <div class="fg-col">
                  <label class="lbl">Hor√°rio</label>
                  <input type="time" name="time_str" class="field field-light" />
                </div>
                <div class="fg-col">
                  <label class="lbl">Companhia</label>
                  <input name="company" class="field field-light" placeholder="Ex: Latam" />
                </div>
              </div>

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Origem</label>
                  <input name="origin" class="field field-light" placeholder="Cidade/Aeroporto" />
                </div>
                <div class="fg-col">
                  <label class="lbl">Destino</label>
                  <input name="destination" class="field field-light" placeholder="Cidade/Aeroporto" />
                </div>
              </div>

              <div class="fg fg-3">
                <div class="fg-col">
                  <label class="lbl">Dura√ß√£o</label>
                  <input name="flight_duration" class="field field-light" placeholder="Ex: 2h30" />
                </div>
                <div class="fg-col">
                  <label class="lbl">Conex√£o</label>
                  <div class="toggle-card">
                    <input type="checkbox" id="hasConn" name="has_connection" class="accent-indigo-500" />
                    <div>
                      <p class="font-semibold text-sm">Tem conex√£o</p>
                      <p class="text-xs text-slate-500">Mostra trecho</p>
                    </div>
                  </div>
                </div>
                <div class="fg-col">
                  <label class="lbl">Valor</label>
                  <input name="cost" class="field field-light" placeholder="Ex: 1200,00" />
                </div>
              </div>

              <div id="connBox" class="hidden rounded-2xl border border-slate-200 bg-white p-4 grid gap-2">
                <p class="text-sm text-slate-700 font-semibold">Dados da conex√£o</p>
                <div class="grid lg:grid-cols-2 gap-2">
                  <div>
                    <label class="lbl">Origem do trecho</label>
                    <input name="conn_origin" class="field field-light" placeholder="Origem" />
                  </div>
                  <div>
                    <label class="lbl">Destino (conex√£o)</label>
                    <input name="conn_destination" class="field field-light" placeholder="Conex√£o" />
                  </div>
                </div>
                <div class="grid lg:grid-cols-2 gap-2">
                  <div>
                    <label class="lbl">Dura√ß√£o do trecho</label>
                    <input name="conn_duration" class="field field-light" placeholder="Ex: 1h10" />
                  </div>
                  <div>
                    <label class="lbl">Espera</label>
                    <input name="conn_wait" class="field field-light" placeholder="Ex: 1h20" />
                  </div>
                </div>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Nota</label>
                <textarea name="notes" class="field field-light textarea-big" rows="4" placeholder="Observa√ß√µes..."></textarea>
              </div>

              <div class="flex justify-end">
                <button class="btn-primary">Salvar passagem</button>
              </div>
            </form>
          </div>

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h3 class="panel-title-sm">Passagens por dia</h3>
                <p class="panel-sub">Cada data vira uma linha (mais f√°cil bater o olho).</p>
              </div>
              <div class="badge-count">{{ flights|length }} itens</div>
            </div>

            {% if flights|length == 0 %}
              <div class="empty-state mt-4">
                <div class="empty-ico">‚úàÔ∏è</div>
                <div>
                  <p class="font-semibold text-slate-100">Nenhuma passagem salva</p>
                  <p class="text-slate-400 text-sm">Adicione pelo formul√°rio acima.</p>
                </div>
              </div>
            {% else %}
              {% set nsf = namespace(bydate={}) %}
              {% for it in flights %}
                {% set d = (it.item_date|string) %}
                {% if d in nsf.bydate %}
                  {% set _ = nsf.bydate[d].append(it) %}
                {% else %}
                  {% set _ = nsf.bydate.update({d: [it]}) %}
                {% endif %}
              {% endfor %}

              <div class="mt-4 grid gap-4">
                {% for d, items in nsf.bydate|dictsort %}
                  <div class="day-row">
                    <div class="day-head">
                      <div class="day-date">üìÖ {{ d }}</div>
                      <div class="day-count">{{ items|length }} itens</div>
                    </div>

                    <div class="strip-wrap">
                      <button type="button" class="strip-btn left" data-strip="left">‚Äπ</button>
                      <div class="strip-viewport">
                        <div class="strip" data-strip="1">
                          {% for it in items %}
                            <button type="button"
                              class="saved-card compact js-open-modal"
                              data-id="{{ it.id }}"
                              data-category="{{ it.category }}"
                              data-title="{{ it.title|e }}"
                              data-date="{{ it.item_date }}"
                              data-time="{{ it._meta.get('time','')|e }}"
                              data-company="{{ it._meta.get('company','')|e }}"
                              data-origin="{{ it._meta.get('origin','')|e }}"
                              data-destination="{{ it._meta.get('destination','')|e }}"
                              data-duration="{{ it._meta.get('duration','')|e }}"
                              data-has-connection="{{ '1' if it._meta.get('has_connection') else '0' }}"
                              data-notes="{{ it._meta.get('notes','')|e }}"
                              data-cost="{{ trip.currency }} {{ cents_to_money(it.cost) if it.cost is not none else '' }}"
                            >
                              <div class="saved-body">
                                <div class="flex items-start justify-between gap-2">
                                  <p class="saved-title">{{ it.title }}</p>
                                  {% if it.cost is not none %}
                                    <span class="saved-cost">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>
                                  {% endif %}
                                </div>

                                <div class="saved-meta">
                                  {% if it._meta.get("time") %}<span class="tag">üïí {{ it._meta.get("time") }}</span>{% endif %}
                                  {% if it._meta.get("company") %}<span class="tag">‚úàÔ∏è {{ it._meta.get("company") }}</span>{% endif %}
                                </div>

                                <div class="route-line">
                                  <span class="route">{{ it._meta.get("origin","") }}</span>
                                  <span class="arrow">‚Üí</span>
                                  <span class="route">{{ it._meta.get("destination","") }}</span>
                                </div>

                                <div class="saved-actions-hint">
                                  <span class="hint-pill">Exibir</span>
                                  {% if it._meta.get("has_connection") %}<span class="hint-pill">Conex√£o</span>{% endif %}
                                </div>
                              </div>
                            </button>
                          {% endfor %}
                        </div>
                      </div>
                      <button type="button" class="strip-btn right" data-strip="right">‚Ä∫</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- ===================================================== -->
      <!-- HOSPEDAGENS -->
      <div class="tab-panel" id="tab-hospedagens">
        <div class="grid gap-4">

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h2 class="panel-title">Hospedagens</h2>
                <p class="panel-sub">Salve e visualize com mapa (lazy-load premium).</p>
              </div>
              <div class="badge-count">{{ hotels|length }} salvos</div>
            </div>

            <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 form-grid">
              <input type="hidden" name="category" value="hotel" />

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Nome</label>
                  <input name="title" class="field field-light" placeholder="Ex: Hotel Roma Central" required />
                </div>
                <div class="fg-col">
                  <label class="lbl">Tipo</label>
                  <select name="hotel_type" class="field field-light">
                    <option value="">Selecione</option>
                    <option>Hotel</option>
                    <option>Airbnb</option>
                    <option>Casa de amigos</option>
                  </select>
                </div>
              </div>

              <div class="fg fg-3">
                <div class="fg-col">
                  <label class="lbl">Check-in</label>
                  <input type="date" name="checkin_date" min="{{ trip.start_date }}" max="{{ trip.end_date }}" class="field field-light" required />
                </div>
                <div class="fg-col">
                  <label class="lbl">Noites</label>
                  <input id="hotelNights" name="nights" class="field field-light" placeholder="Ex: 5" />
                </div>
                <div class="fg-col">
                  <label class="lbl">Di√°ria</label>
                  <input id="hotelDaily" name="daily_value" class="field field-light" placeholder="Ex: 350,00" />
                </div>
              </div>

              <div class="calc-box">
                <div>
                  <p class="text-xs text-slate-400">Total (auto)</p>
                  <p class="text-lg font-semibold text-slate-100">
                    {{ trip.currency }} <span id="hotelTotal"></span>
                  </p>
                </div>
                <p class="text-xs text-slate-500">O backend salva o total automaticamente.</p>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Endere√ßo</label>
                <div class="flex gap-2">
                  <input id="addrHotel" name="address" class="field field-light w-full" placeholder="Rua, bairro, cidade..." />
                  <button type="button" class="btn-soft" onclick="openMaps('addrHotel')">Maps</button>
                </div>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Nota</label>
                <textarea name="notes" class="field field-light textarea-big" rows="4" placeholder="Observa√ß√µes..."></textarea>
              </div>

              <input name="cost" class="hidden" />

              <div class="flex justify-end">
                <button class="btn-primary">Salvar hospedagem</button>
              </div>
            </form>
          </div>

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h3 class="panel-title-sm">Hospedagens por dia</h3>
                <p class="panel-sub">Cada check-in vira uma linha (cards rolam dentro do dia).</p>
              </div>
              <div class="badge-count">{{ hotels|length }} itens</div>
            </div>

            {% if hotels|length == 0 %}
              <div class="empty-state mt-4">
                <div class="empty-ico">üè®</div>
                <div>
                  <p class="font-semibold text-slate-100">Nenhuma hospedagem salva</p>
                  <p class="text-slate-400 text-sm">Adicione acima e organize por noites.</p>
                </div>
              </div>
            {% else %}
              {% set nsh = namespace(bydate={}) %}
              {% for it in hotels %}
                {% set d = (it.item_date|string) %}
                {% if d in nsh.bydate %}
                  {% set _ = nsh.bydate[d].append(it) %}
                {% else %}
                  {% set _ = nsh.bydate.update({d: [it]}) %}
                {% endif %}
              {% endfor %}

              <div class="mt-4 grid gap-4">
                {% for d, items in nsh.bydate|dictsort %}
                  <div class="day-row">
                    <div class="day-head">
                      <div class="day-date">üìÖ {{ d }}</div>
                      <div class="day-count">{{ items|length }} itens</div>
                    </div>

                    <div class="strip-wrap">
                      <button type="button" class="strip-btn left" data-strip="left">‚Äπ</button>
                      <div class="strip-viewport">
                        <div class="strip" data-strip="1">
                          {% for it in items %}
                            {% set addr = it._meta.get("address","") %}
                            <button type="button"
                              class="saved-card js-open-modal"
                              data-id="{{ it.id }}"
                              data-category="{{ it.category }}"
                              data-title="{{ it.title|e }}"
                              data-date="{{ it.item_date }}"
                              data-address="{{ addr|e }}"
                              data-notes="{{ it._meta.get('notes','')|e }}"
                              data-cost="{{ trip.currency }} {{ cents_to_money(it.cost) if it.cost is not none else '' }}"
                            >
                              <div class="saved-map">
                                {% if addr %}
                                  <iframe
                                    class="saved-iframe js-lazy-map"
                                    loading="lazy"
                                    referrerpolicy="no-referrer-when-downgrade"
                                    data-src="https://www.google.com/maps?q={{ addr|urlencode }}&output=embed"></iframe>
                                {% else %}
                                  <div class="saved-map-fallback"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                {% endif %}
                                <div class="saved-gradient"></div>
                              </div>

                              <div class="saved-body">
                                <div class="flex items-start justify-between gap-2">
                                  <p class="saved-title">{{ it.title }}</p>
                                  {% if it.cost is not none %}
                                    <span class="saved-cost">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>
                                  {% endif %}
                                </div>

                                <div class="saved-meta">
                                  {% if it._meta.get("nights") %}<span class="tag">üåô {{ it._meta.get("nights") }} noites</span>{% endif %}
                                  {% if it._meta.get("hotel_type") %}<span class="tag">üè∑Ô∏è {{ it._meta.get("hotel_type") }}</span>{% endif %}
                                </div>

                                {% if addr %}
                                  <p class="saved-addr">{{ addr }}</p>
                                {% else %}
                                  <p class="saved-addr muted">Sem endere√ßo</p>
                                {% endif %}

                                <div class="saved-actions-hint">
                                  <span class="hint-pill">Exibir</span>
                                  <span class="hint-pill">Mapa</span>
                                </div>
                              </div>
                            </button>
                          {% endfor %}
                        </div>
                      </div>
                      <button type="button" class="strip-btn right" data-strip="right">‚Ä∫</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- ===================================================== -->
      <!-- RESTAURANTES -->
      <div class="tab-panel" id="tab-restaurantes">
        <div class="grid gap-4">

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h2 class="panel-title">Restaurantes</h2>
                <p class="panel-sub">Salve por data e refei√ß√£o. Cards aparecem por dia abaixo.</p>
              </div>
              <div class="badge-count">{{ rests|length }} salvos</div>
            </div>

            <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 form-grid">
              <input type="hidden" name="category" value="restaurant" />

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Nome</label>
                  <input name="title" class="field field-light" placeholder="Ex: Trattoria da Maria" required />
                </div>
                <div class="fg-col fg-2-inner">
                  <div>
                    <label class="lbl">Data</label>
                    <input type="date" name="planned_date" min="{{ trip.start_date }}" max="{{ trip.end_date }}" class="field field-light" required />
                  </div>
                  <div>
                    <label class="lbl">Tipo</label>
                    <select name="meal_type" class="field field-light">
                      <option value="">Selecione</option>
                      <option>Caf√© da manh√£</option>
                      <option>Almo√ßo</option>
                      <option>Jantar</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Endere√ßo</label>
                <div class="flex gap-2">
                  <input id="addrRest" name="address" class="field field-light w-full" placeholder="Rua, bairro, cidade..." />
                  <button type="button" class="btn-soft" onclick="openMaps('addrRest')">Maps</button>
                </div>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Nota</label>
                <textarea name="notes" class="field field-light textarea-big" rows="4" placeholder="Observa√ß√µes..."></textarea>
              </div>

              <div class="flex justify-end">
                <button class="btn-primary">Salvar restaurante</button>
              </div>
            </form>
          </div>

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h3 class="panel-title-sm">Restaurantes por dia</h3>
                <p class="panel-sub">Cada data vira uma linha com cards + mapa (lazy-load).</p>
              </div>
              <div class="badge-count">{{ rests|length }} itens</div>
            </div>

            {% if rests|length == 0 %}
              <div class="empty-state mt-4">
                <div class="empty-ico">üçù</div>
                <div>
                  <p class="font-semibold text-slate-100">Nenhum restaurante salvo</p>
                  <p class="text-slate-400 text-sm">Salve e organize por refei√ß√µes.</p>
                </div>
              </div>
            {% else %}
              {% set nsr = namespace(bydate={}) %}
              {% for it in rests %}
                {% set d = (it.item_date|string) %}
                {% if d in nsr.bydate %}
                  {% set _ = nsr.bydate[d].append(it) %}
                {% else %}
                  {% set _ = nsr.bydate.update({d: [it]}) %}
                {% endif %}
              {% endfor %}

              <div class="mt-4 grid gap-4">
                {% for d, items in nsr.bydate|dictsort %}
                  <div class="day-row">
                    <div class="day-head">
                      <div class="day-date">üìÖ {{ d }}</div>
                      <div class="day-count">{{ items|length }} itens</div>
                    </div>

                    <div class="strip-wrap">
                      <button type="button" class="strip-btn left" data-strip="left">‚Äπ</button>
                      <div class="strip-viewport">
                        <div class="strip" data-strip="1">
                          {% for it in items %}
                            {% set addr = it._meta.get("address","") %}
                            <button type="button"
                              class="saved-card js-open-modal"
                              data-id="{{ it.id }}"
                              data-category="{{ it.category }}"
                              data-title="{{ it.title|e }}"
                              data-date="{{ it.item_date }}"
                              data-meal="{{ it._meta.get('meal_type','')|e }}"
                              data-address="{{ addr|e }}"
                              data-notes="{{ it._meta.get('notes','')|e }}"
                            >
                              <div class="saved-map">
                                {% if addr %}
                                  <iframe
                                    class="saved-iframe js-lazy-map"
                                    loading="lazy"
                                    referrerpolicy="no-referrer-when-downgrade"
                                    data-src="https://www.google.com/maps?q={{ addr|urlencode }}&output=embed"></iframe>
                                {% else %}
                                  <div class="saved-map-fallback"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                {% endif %}
                                <div class="saved-gradient"></div>
                              </div>

                              <div class="saved-body">
                                <div class="flex items-start justify-between gap-2">
                                  <p class="saved-title">{{ it.title }}</p>
                                </div>

                                <div class="saved-meta">
                                  {% if it._meta.get("meal_type") %}<span class="tag">üçΩ {{ it._meta.get("meal_type") }}</span>{% endif %}
                                </div>

                                {% if addr %}
                                  <p class="saved-addr">{{ addr }}</p>
                                {% else %}
                                  <p class="saved-addr muted">Sem endere√ßo</p>
                                {% endif %}

                                <div class="saved-actions-hint">
                                  <span class="hint-pill">Exibir</span>
                                  <span class="hint-pill">Mapa</span>
                                </div>
                              </div>
                            </button>
                          {% endfor %}
                        </div>
                      </div>
                      <button type="button" class="strip-btn right" data-strip="right">‚Ä∫</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- ===================================================== -->
      <!-- TRANSPORTE -->
      <div class="tab-panel" id="tab-transporte">
        <div class="grid gap-4">

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h2 class="panel-title">Transporte</h2>
                <p class="panel-sub">Cada data vira uma linha, cards rolam dentro do dia.</p>
              </div>
              <div class="badge-count">{{ trans|length }} salvos</div>
            </div>

            <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 form-grid">
              <input type="hidden" name="category" value="transport" />

              <div class="fg fg-3">
                <div class="fg-col">
                  <label class="lbl">Tipo</label>
                  <select name="transport_type" class="field field-light" required>
                    <option value="">Selecione</option>
                    <option>√înibus</option>
                    <option>Trem</option>
                    <option>Barco</option>
                    <option>Uber/Taxi</option>
                    <option>Loca√ß√£o de carro</option>
                    <option>Outro</option>
                  </select>
                </div>
                <div class="fg-col">
                  <label class="lbl">Data</label>
                  <input type="date" name="transport_date" min="{{ trip.start_date }}" max="{{ trip.end_date }}" class="field field-light" required />
                </div>
                <div class="fg-col">
                  <label class="lbl">Dura√ß√£o</label>
                  <input name="transport_duration" class="field field-light" placeholder="Ex: 1h20" />
                </div>
              </div>

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Aluguel de carro</label>
                  <div class="toggle-card">
                    <input type="checkbox" id="isCar" name="is_car_rental" class="accent-indigo-500" />
                    <div>
                      <p class="font-semibold text-sm">√â aluguel</p>
                      <p class="text-xs text-slate-500">Mostra di√°rias</p>
                    </div>
                  </div>
                </div>
                <div class="fg-col">
                  <div id="carBox" class="hidden rounded-2xl border border-slate-200 bg-white p-4 grid md:grid-cols-2 gap-2">
                    <div>
                      <label class="lbl">Di√°ria</label>
                      <input name="car_daily" class="field field-light" placeholder="Ex: 250,00" />
                    </div>
                    <div>
                      <label class="lbl">Qtd di√°rias</label>
                      <input name="car_days" class="field field-light" placeholder="Ex: 5" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="fg fg-2">
                <div class="fg-col">
                  <label class="lbl">Link bilhete/reserva</label>
                  <input name="transport_link" class="field field-light" placeholder="URL (opcional)" />
                </div>
                <div class="fg-col">
                  <label class="lbl">Valor</label>
                  <input name="cost" class="field field-light" placeholder="Ex: 70,00" />
                </div>
              </div>

              <div class="fg fg-1">
                <label class="lbl">Nota</label>
                <textarea name="notes" class="field field-light textarea-big" rows="4" placeholder="Observa√ß√µes..."></textarea>
              </div>

              <div class="flex justify-end">
                <button class="btn-primary">Salvar transporte</button>
              </div>
            </form>
          </div>

          <div class="panel-card">
            <div class="panel-head">
              <div>
                <h3 class="panel-title-sm">Transportes por dia</h3>
                <p class="panel-sub">Vis√£o por data (√≥timo para ‚Äúbater o olho‚Äù).</p>
              </div>
              <div class="badge-count">{{ trans|length }} itens</div>
            </div>

            {% if trans|length == 0 %}
              <div class="empty-state mt-4">
                <div class="empty-ico">üöå</div>
                <div>
                  <p class="font-semibold text-slate-100">Nenhum transporte salvo</p>
                  <p class="text-slate-400 text-sm">Adicione acima e organize por datas.</p>
                </div>
              </div>
            {% else %}
              {% set nst = namespace(bydate={}) %}
              {% for it in trans %}
                {% set d = (it.item_date|string) %}
                {% if d in nst.bydate %}
                  {% set _ = nst.bydate[d].append(it) %}
                {% else %}
                  {% set _ = nst.bydate.update({d: [it]}) %}
                {% endif %}
              {% endfor %}

              <div class="mt-4 grid gap-4">
                {% for d, items in nst.bydate|dictsort %}
                  <div class="day-row">
                    <div class="day-head">
                      <div class="day-date">üìÖ {{ d }}</div>
                      <div class="day-count">{{ items|length }} itens</div>
                    </div>

                    <div class="strip-wrap">
                      <button type="button" class="strip-btn left" data-strip="left">‚Äπ</button>
                      <div class="strip-viewport">
                        <div class="strip" data-strip="1">
                          {% for it in items %}
                            <button type="button"
                              class="saved-card compact js-open-modal"
                              data-id="{{ it.id }}"
                              data-category="{{ it.category }}"
                              data-title="{{ it.title|e }}"
                              data-date="{{ it.item_date }}"
                              data-transport-type="{{ it._meta.get('transport_type','')|e }}"
                              data-duration="{{ it._meta.get('duration','')|e }}"
                              data-url="{{ (it._meta.get('ticket_url','') or it.url or it._meta.get('transport_link',''))|e }}"
                              data-notes="{{ it._meta.get('notes','')|e }}"
                              data-cost="{{ trip.currency }} {{ cents_to_money(it.cost) if it.cost is not none else '' }}"
                            >
                              <div class="saved-body">
                                <div class="flex items-start justify-between gap-2">
                                  <p class="saved-title">{{ it.title }}</p>
                                  {% if it.cost is not none %}
                                    <span class="saved-cost">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>
                                  {% endif %}
                                </div>

                                <div class="saved-meta">
                                  {% if it._meta.get("transport_type") %}<span class="tag">üß≠ {{ it._meta.get("transport_type") }}</span>{% endif %}
                                  {% if it._meta.get("duration") %}<span class="tag">‚è± {{ it._meta.get("duration") }}</span>{% endif %}
                                </div>

                                <div class="saved-actions-hint">
                                  <span class="hint-pill">Exibir</span>
                                  {% if it._meta.get("transport_link") %}<span class="hint-pill">Link</span>{% endif %}
                                </div>
                              </div>
                            </button>
                          {% endfor %}
                        </div>
                      </div>
                      <button type="button" class="strip-btn right" data-strip="right">‚Ä∫</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- ===================================================== -->
      <!-- CUSTOS -->
      <div class="tab-panel" id="tab-custos">
        <div class="panel-card">
          <div class="panel-head">
            <div>
              <h2 class="panel-title">Custos</h2>
              <p class="panel-sub">Somat√≥rio por categoria e total geral.</p>
            </div>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-3">
            <div class="box">
              <p class="text-sm text-slate-400">Passeios</p>
              <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_by_cat.get("activity",0)) }}</p>
            </div>
            <div class="box">
              <p class="text-sm text-slate-400">Passagens</p>
              <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_by_cat.get("flight",0)) }}</p>
            </div>
            <div class="box">
              <p class="text-sm text-slate-400">Hospedagens</p>
              <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_by_cat.get("hotel",0)) }}</p>
            </div>
            <div class="box">
              <p class="text-sm text-slate-400">Restaurantes</p>
              <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_by_cat.get("restaurant",0)) }}</p>
            </div>
            <div class="box">
              <p class="text-sm text-slate-400">Transporte</p>
              <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_by_cat.get("transport",0)) }}</p>
            </div>
          </div>

          <div class="mt-4 box">
            <p class="text-sm text-slate-400">Total</p>
            <p class="text-2xl font-semibold">{{ trip.currency }} {{ cents_to_money(total_all) }}</p>
          </div>
        </div>
      </div>

      <!-- MODAL -->
      <div id="itemModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-backdrop" data-close="1"></div>

        <div class="modal-card" role="document">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p id="mTitle" class="text-lg font-semibold text-slate-100 truncate"></p>
              <p id="mSub" class="text-sm text-slate-300 mt-1"></p>
            </div>
            <button type="button" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition" data-close="1">
              Fechar
            </button>
          </div>

          <div id="mChips" class="mt-3 flex flex-wrap gap-2"></div>

          <div id="mMapBox" class="mt-4 hidden rounded-2xl overflow-hidden border border-slate-800">
            <iframe id="mMap" class="w-full h-56" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>

          <div id="mNotes" class="mt-4 text-sm text-slate-200 whitespace-pre-wrap hidden"></div>

          <div class="mt-5 flex flex-wrap gap-2 justify-between items-center">
            <div class="flex flex-wrap gap-2">
              <a id="mUrl" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition font-medium hidden" target="_blank">Abrir link</a>
              <a id="mMapsLink" class="px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium hidden" target="_blank">Abrir no Maps</a>
            </div>

            <div class="flex gap-2">
              <button type="button" id="mEditBtn" class="px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
                Editar
              </button>
              <form id="mDeleteForm" method="post">
                <button type="submit" class="px-4 py-2 rounded-2xl bg-rose-700 hover:bg-rose-600 transition font-medium">
                  Excluir
                </button>
              </form>
            </div>
          </div>

          <div id="mEditBox" class="mt-4 hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <p class="text-sm text-slate-300 font-semibold">Editar item</p>
            <form id="mEditForm" method="post" class="mt-3 grid gap-3"></form>
          </div>
        </div>
      </div>

    {% endif %}
  </div>
</div>

<style>
  html, body { overflow-x: hidden; }

  /* Tabs */
  .tab-btn{
    white-space:nowrap; padding:.6rem 1rem; border-radius:9999px;
    border:1px solid rgb(30 41 59);
    background:rgb(2 6 23);
    color:rgb(226 232 240);
    transition:.15s;
    font-weight:600;
    font-size:.9rem;
  }
  .tab-btn:hover{ background:rgb(15 23 42); }
  .tab-btn.active{ border-color:rgb(99 102 241); box-shadow:0 0 0 2px rgba(99,102,241,.25); }
  .tab-panel{ display:none; }
  .tab-panel.active{ display:block; }

  /* Fields */
  .field{
    border-radius:.9rem;
    background:rgb(2 6 23);
    border:1px solid rgb(30 41 59);
    padding:.7rem .85rem;
    color:rgb(226 232 240);
  }
  .field-light{
    background:#fff !important;
    color:#0f172a !important;
    border-color:rgba(148,163,184,.45) !important;
  }
  .field-light::placeholder{ color:rgba(100,116,139,.9); }

  .lbl{
    display:block;
    font-size:.78rem;
    color:rgb(71 85 105);
    font-weight:800;
    margin:0 0 .35rem .15rem;
  }
  .textarea-big{ min-height:110px; resize:vertical; }

  .chip{
    padding:.35rem .55rem;
    border-radius:.85rem;
    background:rgb(15 23 42);
    border:1px solid rgb(51 65 85);
    color:rgb(226 232 240);
    font-size:.85rem;
  }
  .hidden{ display:none !important; }

  /* Panels */
  .panel-card{
    border-radius:1.25rem;
    border:1px solid rgb(30 41 59);
    background:linear-gradient(180deg, rgba(15,23,42,.60), rgba(2,6,23,.70));
    padding:1.25rem;
  }
  .panel-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
  }
  .panel-title{
    font-size:1.25rem;
    font-weight:900;
    color:rgb(226 232 240);
    letter-spacing:-.01em;
  }
  .panel-title-sm{
    font-size:1.05rem;
    font-weight:900;
    color:rgb(226 232 240);
  }
  .panel-sub{
    margin-top:.25rem;
    font-size:.9rem;
    color:rgb(148 163 184);
  }
  .badge-count{
    padding:.35rem .6rem;
    border-radius:9999px;
    background:rgba(2,6,23,.75);
    border:1px solid rgb(51 65 85);
    color:rgb(203 213 225);
    font-size:.8rem;
    font-weight:800;
    white-space:nowrap;
  }

  .btn-primary{
    padding:.75rem 1.05rem;
    border-radius:9999px;
    background:rgb(99 102 241);
    color:#fff;
    font-weight:900;
    transition:.15s;
  }
  .btn-primary:hover{ background:rgb(79 70 229); transform:translateY(-1px); }

  .btn-soft{
    padding:.65rem .9rem;
    border-radius:9999px;
    background:rgb(15 23 42);
    border:1px solid rgb(51 65 85);
    color:rgb(226 232 240);
    font-weight:800;
    transition:.15s;
    white-space:nowrap;
  }
  .btn-soft:hover{ background:rgb(30 41 59); }

  .toggle-card{
    display:flex; align-items:center; gap:.7rem;
    background:#fff;
    border:1px solid rgba(148,163,184,.45);
    border-radius:1rem;
    padding:.75rem .85rem;
    color:#0f172a;
  }

  .calc-box{
    border-radius:1.1rem;
    border:1px solid rgb(51 65 85);
    background:rgba(2,6,23,.75);
    padding:.9rem;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:1rem;
  }

  .box{ border-radius:1rem; border:1px solid rgb(30 41 59); background:rgb(2 6 23); padding:1rem; }

  /* Form grid helper */
  .form-grid{ display:grid; gap:1rem; }
  .fg{ display:grid; gap:.75rem; }
  .fg-1{ grid-template-columns: 1fr; }
  .fg-2{ grid-template-columns: 1fr; }
  .fg-3{ grid-template-columns: 1fr; }
  .fg-col{ min-width:0; }
  .fg-2-inner{ display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }

  @media (min-width: 1024px){
    .fg-2{ grid-template-columns: 1fr 1fr; align-items:end; }
    .fg-3{ grid-template-columns: 1fr 1fr 1fr; align-items:end; }
  }

  /* Empty */
  .empty-state{
    display:flex;
    align-items:center;
    gap:1rem;
    padding:1rem;
    border-radius:1rem;
    border:1px dashed rgb(51 65 85);
    background:rgba(2,6,23,.6);
  }
  .empty-ico{
    width:44px; height:44px;
    border-radius:14px;
    display:grid; place-items:center;
    background:rgba(99,102,241,.18);
    border:1px solid rgba(99,102,241,.25);
    font-size:1.2rem;
  }

  /* Day blocks */
  .day-row{
    border-radius:1.15rem;
    border:1px solid rgba(51,65,85,.7);
    background:rgba(2,6,23,.35);
    padding:1rem;
  }
  .day-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:1rem;
    margin-bottom:.75rem;
  }
  .day-date{
    font-weight:900;
    color:rgb(226 232 240);
  }
  .day-count{
    font-size:.8rem;
    font-weight:800;
    color:rgb(203 213 225);
    padding:.25rem .55rem;
    border-radius:9999px;
    background:rgba(2,6,23,.75);
    border:1px solid rgb(51 65 85);
  }

  /* ===== STRIP: 4 cards no viewport, rolagem s√≥ dentro ===== */
  .strip-wrap{ position:relative; max-width:100%; min-width:0; }
  .strip-viewport{ overflow:hidden; max-width:100%; min-width:0; padding:.25rem 0; }
  .strip{
    display:grid;
    grid-auto-flow:column;
    gap:.9rem;
    overflow-x:auto;
    overflow-y:hidden;
    padding:.35rem 2.7rem .55rem .15rem;
    scroll-snap-type:x mandatory;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-x:contain;
    max-width:100%;
    min-width:0;
    scrollbar-gutter:stable;
    grid-auto-columns: calc((100% - (3 * .9rem)) / 4);
  }
  @media (max-width: 1024px){
    .strip{ grid-auto-columns: calc((100% - (2 * .9rem)) / 3); }
  }
  @media (max-width: 768px){
    .strip{ grid-auto-columns: calc((100% - (1 * .9rem)) / 2); }
  }
  @media (max-width: 520px){
    .strip{ grid-auto-columns: 85%; }
  }
  .strip::-webkit-scrollbar{ height:10px; }
  .strip::-webkit-scrollbar-thumb{ background:#334155; border-radius:9999px; }

  .strip-btn{
    position:absolute; top:50%; transform:translateY(-50%);
    width:36px; height:36px; border-radius:9999px;
    background:rgba(2,6,23,.92);
    border:1px solid rgb(30 41 59);
    color:rgb(226 232 240);
    display:grid; place-items:center;
    z-index:5;
  }
  .strip-btn.left{ left:6px; }
  .strip-btn.right{ right:6px; }
  .strip-btn:hover{ background:rgb(15 23 42); }

  /* Saved card */
  .saved-card{
    scroll-snap-align:start;
    border-radius:1.15rem;
    border:1px solid rgb(30 41 59);
    background:rgba(15,23,42,.55);
    overflow:hidden;
    text-align:left;
    transition:.15s;
    min-width:0;
  }
  .saved-card:hover{
    background:rgba(15,23,42,.72);
    transform:translateY(-1px);
    border-color:rgba(99,102,241,.35);
  }
  .saved-card.compact .saved-map{ display:none; }

  /* Map preview (lazy) */
  .saved-map{
    position:relative;
    height:118px;
    background:rgba(2,6,23,.7);
  }
  .saved-iframe{
    position:absolute; inset:0;
    width:100%; height:100%;
    border:0;
    pointer-events:none; /* clique continua no card */
    filter:saturate(1.05) contrast(1.05);
    opacity:0;
    transition:opacity .25s ease;
  }
  .saved-iframe.is-loaded{ opacity:1; }
  .saved-gradient{
    position:absolute; inset:0;
    background:linear-gradient(180deg, rgba(2,6,23,.0), rgba(2,6,23,.88));
    pointer-events:none;
  }

  /* Skeleton */
  .saved-skel{
    position:absolute; inset:0;
    background:
      linear-gradient(110deg, rgba(99,102,241,.10) 8%, rgba(14,165,233,.10) 18%, rgba(99,102,241,.10) 33%),
      rgba(2,6,23,.85);
    background-size: 200% 100%;
    animation: shimmer 1.1s linear infinite;
  }
  @keyframes shimmer { to { background-position-x: -200%; } }

  .saved-map-fallback{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    gap:.5rem;
    background:radial-gradient(120px 80px at 30% 40%, rgba(99,102,241,.25), transparent),
               radial-gradient(140px 90px at 75% 60%, rgba(14,165,233,.20), transparent),
               rgba(2,6,23,.85);
  }
  .saved-map-fallback .dot{
    width:10px; height:10px; border-radius:99px;
    background:rgba(226,232,240,.65);
    box-shadow:0 0 0 6px rgba(226,232,240,.08);
  }

  .saved-body{ padding:.95rem; }
  .saved-title{
    font-weight:950;
    color:rgb(226 232 240);
    font-size:.98rem;
    line-height:1.15rem;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .saved-cost{
    font-size:.82rem;
    font-weight:900;
    padding:.25rem .5rem;
    border-radius:9999px;
    background:rgba(99,102,241,.18);
    border:1px solid rgba(99,102,241,.28);
    color:rgb(226 232 240);
    white-space:nowrap;
  }
  .saved-meta{
    display:flex;
    flex-wrap:wrap;
    gap:.4rem;
    margin-top:.6rem;
  }
  .tag{
    font-size:.75rem;
    color:rgb(203 213 225);
    padding:.22rem .5rem;
    border-radius:9999px;
    background:rgba(2,6,23,.75);
    border:1px solid rgb(51 65 85);
    white-space:nowrap;
  }
  .saved-addr{
    margin-top:.6rem;
    font-size:.82rem;
    color:rgb(148 163 184);
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .saved-addr.muted{ color:rgb(100 116 139); }

  .saved-actions-hint{
    margin-top:.75rem;
    display:flex;
    gap:.45rem;
    flex-wrap:wrap;
  }
  .hint-pill{
    font-size:.72rem;
    font-weight:900;
    color:rgb(226 232 240);
    padding:.22rem .55rem;
    border-radius:9999px;
    background:rgba(15,23,42,.6);
    border:1px solid rgb(51 65 85);
  }

  .route-line{
    margin-top:.65rem;
    display:flex;
    align-items:center;
    gap:.5rem;
    padding:.6rem .7rem;
    border-radius:1rem;
    background:rgba(2,6,23,.6);
    border:1px solid rgb(51 65 85);
    color:rgb(203 213 225);
    font-weight:900;
    font-size:.85rem;
    overflow:hidden;
  }
  .route{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .arrow{ opacity:.85; }

  /* Modal */
  .modal{ position:fixed; inset:0; z-index:60; padding:1rem; display:none; place-items:center; }
  .modal.open{ display:grid; }
  .modal-backdrop{ position:absolute; inset:0; background:rgba(2,6,23,.72); }
  .modal-card{
    position:relative; width:min(820px,96vw); max-height:88vh; overflow:auto;
    border-radius:1.25rem; border:1px solid rgb(30 41 59);
    background:rgb(2 6 23); padding:1rem;
  }
</style>

<script>
(function(){
  function byId(id){ return document.getElementById(id); }

  window.openMaps = function(inputId){
    const el = byId(inputId);
    if(!el) return;
    const q = (el.value || "").trim();
    if(!q) return;
    window.open("https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(q), "_blank");
  };

  // Copy share link
  (function(){
    const btn = byId("btnCopy");
    const el = byId("shareLink");
    const msg = byId("copyMsg");
    if(!btn || !el) return;
    btn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(el.value);
        if(msg) msg.innerText = "Copiado!";
        setTimeout(() => { if(msg) msg.innerText = ""; }, 1200);
      }catch(e){
        if(msg) msg.innerText = "Falha ao copiar. Copie manualmente.";
      }
    });
  })();

  // Edit trip toggle
  (function(){
    const btn = byId("btnEditTrip");
    const box = byId("editTripBox");
    if(!btn || !box) return;
    btn.addEventListener("click", () => box.classList.toggle("hidden"));
  })();

  // Tabs
  (function() {
    const btns = Array.from(document.querySelectorAll('.tab-btn'));
    const panels = Array.from(document.querySelectorAll('.tab-panel'));
    if(btns.length === 0) return;

    function activate(tabId){
      btns.forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
      panels.forEach(p => p.classList.toggle('active', p.id === tabId));
      localStorage.setItem('tripPlannerTab', tabId);
      // Re-observe maps when switching tabs
      setTimeout(initLazyMaps, 50);
    }

    const saved = localStorage.getItem('tripPlannerTab');
    const first = saved && document.getElementById(saved) ? saved : btns[0].dataset.tab;
    activate(first);

    btns.forEach(b => b.addEventListener('click', () => activate(b.dataset.tab)));
  })();

  // Create mode end date auto
  (function(){
    const start = byId("startDate");
    const dur = byId("durationDays");
    const end = byId("endDate");
    if(!start || !dur || !end) return;

    function calc(){
      const s = start.value;
      const d = parseInt(dur.value || "0", 10);
      if(!s || !d || d <= 0) return;
      const dt = new Date(s + "T00:00:00");
      dt.setDate(dt.getDate() + (d - 1));
      end.value = dt.toISOString().slice(0,10);
    }
    start.addEventListener("change", calc);
    dur.addEventListener("input", calc);
  })();

  // Passeio: gratuito -> esconde pago
  (function(){
    const free = byId("actFree");
    const paid = byId("actPaidBox");
    if(!free || !paid) return;
    const sync = () => paid.classList.toggle("hidden", free.checked);
    free.addEventListener("change", sync);
    sync();
  })();

  // Passagem: conex√£o
  (function(){
    const c = byId("hasConn");
    const box = byId("connBox");
    if(!c || !box) return;
    const sync = () => box.classList.toggle("hidden", !c.checked);
    c.addEventListener("change", sync);
    sync();
  })();

  // Transporte: carro
  (function(){
    const c = byId("isCar");
    const box = byId("carBox");
    if(!c || !box) return;
    const sync = () => box.classList.toggle("hidden", !c.checked);
    c.addEventListener("change", sync);
    sync();
  })();

  // Hospedagem total auto (UI)
  (function(){
    const n = byId("hotelNights");
    const d = byId("hotelDaily");
    const out = byId("hotelTotal");
    if(!n || !d || !out) return;

    function parseMoney(s){
      if(!s) return 0;
      s = String(s).trim().replace(" ", "");
      if(s.includes(",") && s.includes(".")){
        if(s.lastIndexOf(",") > s.lastIndexOf(".")) s = s.replace(/\./g,"").replace(",",".");
        else s = s.replace(/,/g,"");
      } else {
        s = s.replace(",",".");
      }
      const v = parseFloat(s);
      return isNaN(v) ? 0 : v;
    }
    function calc(){
      const nights = parseInt(n.value || "0",10) || 0;
      const daily = parseMoney(d.value);
      const total = nights * daily;
      out.textContent = total ? total.toFixed(2) : "";
    }
    n.addEventListener("input", calc);
    d.addEventListener("input", calc);
    calc();
  })();

  // Strip scroll buttons (all)
  (function(){
    document.querySelectorAll(".strip-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const wrap = btn.closest(".strip-wrap");
        const strip = wrap ? wrap.querySelector(".strip") : null;
        if(!strip) return;
        const dir = btn.dataset.strip;
        const amt = Math.floor(strip.clientWidth * 0.92);
        strip.scrollBy({ left: dir === "left" ? -amt : amt, behavior: "smooth" });
      });
    });
  })();

  // ===== LAZY MAPS (PREMIUM) =====
  let mapObserver = null;

  function initLazyMaps(){
    // Disconnect old observer
    if(mapObserver){ try { mapObserver.disconnect(); } catch(e){} }

    const frames = Array.from(document.querySelectorAll("iframe.js-lazy-map"));
    if(frames.length === 0) return;

    // Put skeleton for all that are not loaded
    frames.forEach(f=>{
      if(f.dataset.loaded === "1") return;
      const parent = f.parentElement;
      if(parent && !parent.querySelector(".saved-skel")){
        const sk = document.createElement("div");
        sk.className = "saved-skel";
        parent.appendChild(sk);
      }
    });

    mapObserver = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(!entry.isIntersecting) return;
        const iframe = entry.target;
        if(iframe.dataset.loaded === "1") { mapObserver.unobserve(iframe); return; }

        const src = iframe.getAttribute("data-src");
        if(src){
          iframe.src = src;
          iframe.dataset.loaded = "1";

          iframe.addEventListener("load", ()=>{
            iframe.classList.add("is-loaded");
            const parent = iframe.parentElement;
            const sk = parent ? parent.querySelector(".saved-skel") : null;
            if(sk) sk.remove();
          }, { once:true });
        }
        mapObserver.unobserve(iframe);
      });
    }, {
      root: null,
      rootMargin: "250px 0px", // carrega antes de aparecer
      threshold: 0.01
    });

    frames.forEach(f=> mapObserver.observe(f));
  }

  // init once
  window.addEventListener("load", initLazyMaps);
  // also in case of dynamic layout changes
  window.addEventListener("resize", ()=> setTimeout(initLazyMaps, 150));

  // ===== MODAL =====
  (function(){
    const root = byId("pageRoot");
    if(!root) return;
    const token = root.dataset.tripToken || "";

    const modal = byId("itemModal");
    if(!modal) return;

    const mTitle = byId("mTitle");
    const mSub = byId("mSub");
    const mChips = byId("mChips");
    const mNotes = byId("mNotes");
    const mMapBox = byId("mMapBox");
    const mMap = byId("mMap");
    const mUrl = byId("mUrl");
    const mMapsLink = byId("mMapsLink");
    const mDeleteForm = byId("mDeleteForm");
    const mEditBtn = byId("mEditBtn");
    const mEditBox = byId("mEditBox");
    const mEditForm = byId("mEditForm");

    function show(){
      modal.classList.add("open");
      document.body.style.overflow = "hidden";
    }
    function hide(){
      modal.classList.remove("open");
      document.body.style.overflow = "";
      if(mMap) mMap.removeAttribute("src");
      if(mEditBox) mEditBox.classList.add("hidden");
      if(mEditForm) mEditForm.innerHTML = "";
    }
    function chip(txt){
      const s = document.createElement("span");
      s.className = "chip";
      s.textContent = txt;
      mChips.appendChild(s);
    }
    function esc(s){ return String(s || "").replaceAll('"', "&quot;"); }

    function openFromBtn(btn){
      const id = btn.dataset.id;
      const title = btn.dataset.title || "";
      const category = btn.dataset.category || "";
      if(!id || !title || !category) return;

      const date = btn.dataset.date || "";
      const address = btn.dataset.address || "";
      const url = btn.dataset.url || "";
      const notes = btn.dataset.notes || "";
      const cost = (btn.dataset.cost || "").trim();

      mTitle.textContent = title;
      mSub.textContent = [category, date].filter(Boolean).join(" ‚Ä¢ ");

      mChips.innerHTML = "";
      if(cost) chip(cost);

      if(btn.dataset.period) chip("üïí " + btn.dataset.period);
      if(btn.dataset.isFree === "1") chip("üÜì Gratuito");
      if(btn.dataset.company) chip("‚úàÔ∏è " + btn.dataset.company);
      if(btn.dataset.origin || btn.dataset.destination) chip((btn.dataset.origin||"") + " ‚Üí " + (btn.dataset.destination||""));
      if(btn.dataset.transportType) chip("üß≠ " + btn.dataset.transportType);
      if(btn.dataset.duration) chip("‚è± " + btn.dataset.duration);
      if(btn.dataset.meal) chip("üçΩ " + btn.dataset.meal);

      if(notes.trim()){
        mNotes.classList.remove("hidden");
        mNotes.textContent = notes;
      } else {
        mNotes.classList.add("hidden");
        mNotes.textContent = "";
      }

      if(url.trim()){
        mUrl.classList.remove("hidden");
        mUrl.href = url;
      } else {
        mUrl.classList.add("hidden");
        mUrl.removeAttribute("href");
      }

      if(address.trim()){
        mMapsLink.classList.remove("hidden");
        mMapsLink.href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(address);
        mMapBox.classList.remove("hidden");
        // Modal pode carregar direto (√© um s√≥)
        mMap.src = "https://www.google.com/maps?q=" + encodeURIComponent(address) + "&output=embed";
      } else {
        mMapsLink.classList.add("hidden");
        mMapBox.classList.add("hidden");
        mMap.removeAttribute("src");
      }

      mDeleteForm.action = `/t/${token}/items/${id}/delete`;

      mEditForm.action = `/t/${token}/items/${id}/edit`;
      mEditForm.innerHTML = `
        <input type="hidden" name="category" value="${esc(category)}">
        <label class="text-sm text-slate-300">T√≠tulo</label>
        <input class="field field-light" name="title" value="${esc(title)}" required>
        <label class="text-sm text-slate-300">Data</label>
        <input class="field field-light" type="date" name="item_date" value="${esc(date)}">
        <label class="text-sm text-slate-300">Endere√ßo</label>
        <input class="field field-light" name="address" value="${esc(address)}">
        <label class="text-sm text-slate-300">Link (opcional)</label>
        <input class="field field-light" name="url" value="${esc(url)}">
        <label class="text-sm text-slate-300">Nota</label>
        <textarea class="field field-light" rows="4" name="notes">${esc(notes).replaceAll("&quot;", '"')}</textarea>
        <button class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition font-medium">
          Salvar edi√ß√£o
        </button>
      `;
      mEditBox.classList.add("hidden");
      mEditBtn.textContent = "Editar";

      show();
    }

    modal.addEventListener("click", (e) => {
      const t = e.target;
      if(t && t.dataset && t.dataset.close === "1") hide();
    });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") hide(); });

    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".js-open-modal");
      if(!btn) return;
      openFromBtn(btn);
    });

    mEditBtn.addEventListener("click", () => {
      const isOpen = !mEditBox.classList.contains("hidden");
      mEditBox.classList.toggle("hidden", isOpen);
      mEditBtn.textContent = isOpen ? "Editar" : "Fechar edi√ß√£o";
    });
  })();

})();
</script>

{% endblock %}
