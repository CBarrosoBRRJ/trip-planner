{% extends "base.html" %}
{% block content %}

<div class="grid gap-6">

  <!-- Header -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">{{ trip.title }}</h1>
        <p class="text-slate-300 mt-1">
          {{ trip.destination }} ‚Ä¢ <span class="font-medium">{{ trip.start_date }}</span> ‚Üí <span class="font-medium">{{ trip.end_date }}</span> ‚Ä¢ {{ trip.currency }}
        </p>

        <div class="mt-4 flex flex-wrap gap-2">
          <a href="{{ gcal_url }}" target="_blank"
             class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 transition font-medium">
            Salvar no Google Agenda
          </a>
        </div>

        <p class="mt-2 text-xs text-slate-400">
          Cada convidado abre e salva na pr√≥pria agenda (Google pede login se precisar).
        </p>
      </div>

      <!-- Share -->
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 w-full lg:w-[520px]">
        <p class="text-sm text-slate-300">Link da viagem (compartilhe no WhatsApp)</p>
        <div class="mt-2 flex gap-2">
          <input id="shareLink" value="{{ share_url }}" readonly
                 class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-slate-100" />
          <button type="button" onclick="copyShareLink()"
                  class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
            Copiar
          </button>
        </div>
        <p id="copyMsg" class="mt-2 text-xs text-slate-400"></p>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-4">
    <div class="flex gap-2 overflow-x-auto pb-1" id="tabs">
      <button class="tab-btn" data-tab="tab-roteiro">Roteiro</button>
      <button class="tab-btn" data-tab="tab-passagens">Passagens</button>
      <button class="tab-btn" data-tab="tab-hoteis">Hot√©is</button>
      <button class="tab-btn" data-tab="tab-restaurantes">Restaurantes</button>
      <button class="tab-btn" data-tab="tab-links">Links</button>
      <button class="tab-btn" data-tab="tab-notas">Anota√ß√µes</button>
      <button class="tab-btn" data-tab="tab-custos">Custos</button>
    </div>
  </div>

  <!-- Content -->
  <div class="grid lg:grid-cols-3 gap-6">

    <!-- Left: Forms (mudam por aba) -->
    <div class="lg:col-span-1 grid gap-6">

      <!-- Form: Passeio / Roteiro -->
      <div class="tab-panel" id="tab-roteiro">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Adicionar Passeio / Dia</h3>

          <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 grid gap-3">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Tipo</label>
                <select name="category" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2">
                  <option value="activity">Passeio</option>
                  <option value="itinerary">Roteiro (bloco do dia)</option>
                  <option value="ticket">Ticket</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-slate-300">Data</label>
                <input type="date" name="item_date" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Hor√°rio</label>
                <input name="time_str" placeholder="Ex: 14:00" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Valor (opcional)</label>
                <input name="cost" placeholder="Ex: 120.00" inputmode="decimal"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Local</label>
              <input name="place" placeholder="Ex: Templo Senso-ji" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Endere√ßo (abre Maps)</label>
              <input name="address" placeholder="Ex: Asakusa, T√≥quio" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Ag√™ncia / sozinho</label>
              <input name="agency" placeholder="Ex: Sozinho / Ag√™ncia X" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Como chegar</label>
              <input name="how_to_get" placeholder="Ex: metr√¥ linha tal, esta√ß√£o tal"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Ingresso / compra (link)</label>
              <input name="url" placeholder="https://..." class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">O que vamos fazer</label>
              <textarea name="notes" rows="3" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2"
                        placeholder="Plano do passeio, observa√ß√µes, etc."></textarea>
            </div>

            <button class="mt-2 px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
              Adicionar ao roteiro
            </button>
          </form>
        </div>
      </div>

      <!-- Form: Passagens -->
      <div class="tab-panel" id="tab-passagens">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Adicionar Passagem</h3>
          <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 grid gap-3">
            <input type="hidden" name="category" value="flight" />
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Data</label>
                <input type="date" name="item_date" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Hor√°rio</label>
                <input name="time_str" placeholder="Ex: 08:35"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Companhia</label>
              <input name="company" placeholder="Ex: LATAM"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Voo (t√≠tulo)</label>
              <input name="title" placeholder="Ex: GRU ‚Üí HND"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Dura√ß√£o</label>
                <input name="duration" placeholder="Ex: 11h40"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Valor</label>
                <input name="cost" placeholder="Ex: 3500.00" inputmode="decimal"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Link (opcional)</label>
              <input name="url" placeholder="https://..."
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <button class="mt-2 px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
              Adicionar passagem
            </button>
          </form>
        </div>
      </div>

      <!-- Form: Hoteis -->
      <div class="tab-panel" id="tab-hoteis">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Adicionar Hotel</h3>
          <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 grid gap-3">
            <input type="hidden" name="category" value="hotel" />

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Check-in</label>
                <input type="date" name="item_date"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Noites</label>
                <input name="nights" placeholder="Ex: 5"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Nome do hotel</label>
              <input name="title" placeholder="Ex: Hotel Shinjuku"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Endere√ßo</label>
              <input name="address" placeholder="Rua, bairro, cidade"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Di√°ria (opcional)</label>
                <input name="daily_value" placeholder="Ex: 650.00" inputmode="decimal"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Custo total (opcional)</label>
                <input name="cost" placeholder="Ex: 3250.00" inputmode="decimal"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Link (opcional)</label>
              <input name="url" placeholder="https://..."
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <button class="mt-2 px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
              Adicionar hotel
            </button>
          </form>
        </div>
      </div>

      <!-- Form: Restaurantes -->
      <div class="tab-panel" id="tab-restaurantes">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Adicionar Restaurante</h3>
          <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 grid gap-3">
            <input type="hidden" name="category" value="restaurant" />

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Data (opcional)</label>
                <input type="date" name="item_date"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Hor√°rio</label>
                <input name="time_str" placeholder="Ex: 19:30"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-300">Nome</label>
              <input name="title" placeholder="Ex: Ichiran Ramen"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div>
              <label class="text-sm text-slate-300">Endere√ßo (abre Maps)</label>
              <input name="address" placeholder="Ex: Shibuya, T√≥quio"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-300">Valor (opcional)</label>
                <input name="cost" placeholder="Ex: 80.00" inputmode="decimal"
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
              <div>
                <label class="text-sm text-slate-300">Link (opcional)</label>
                <input name="url" placeholder="https://..."
                       class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
              </div>
            </div>

            <button class="mt-2 px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
              Adicionar restaurante
            </button>
          </form>
        </div>
      </div>

      <!-- Form: Links -->
      <div class="tab-panel" id="tab-links">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Adicionar Link / Refer√™ncia</h3>
          <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 grid gap-3">
            <input type="hidden" name="category" value="reference" />
            <div>
              <label class="text-sm text-slate-300">T√≠tulo</label>
              <input name="title" placeholder="Ex: Guia do bairro X"
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Link</label>
              <input name="url" placeholder="https://..."
                     class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Notas</label>
              <textarea name="notes" rows="3" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2"></textarea>
            </div>
            <button class="mt-2 px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
              Adicionar link
            </button>
          </form>
        </div>
      </div>

      <!-- Form: Notas -->
      <div class="tab-panel" id="tab-notas">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Anota√ß√µes gerais</h3>
          <form method="post" action="/t/{{ trip.token }}/items" class="mt-4 grid gap-3">
            <input type="hidden" name="category" value="notes" />
            <div>
              <textarea name="notes" rows="5" class="mt-1 w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2"
                        placeholder="Anota√ß√µes livres da viagem..."></textarea>
            </div>
            <button class="mt-2 px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 transition font-medium">
              Salvar anota√ß√£o
            </button>
          </form>
        </div>
      </div>

      <!-- Custos (no mobile √© melhor ter aqui tamb√©m) -->
      <div class="tab-panel" id="tab-custos">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h3 class="text-lg font-semibold">Custos</h3>
          <div class="mt-4 grid gap-3">
            {% for cat, label in category_label.items() %}
              {% if total_by_cat.get(cat) %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <p class="text-sm text-slate-400">{{ label }}</p>
                <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_by_cat.get(cat)) }}</p>
              </div>
              {% endif %}
            {% endfor %}
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
              <p class="text-sm text-slate-400">Total</p>
              <p class="text-lg font-semibold">{{ trip.currency }} {{ cents_to_money(total_all) }}</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Right: Lists (mudam por aba) -->
    <div class="lg:col-span-2 grid gap-6">

      <!-- Roteiro -->
      <div class="tab-panel" id="tab-roteiro">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">Roteiro por dia</h2>
            <span class="text-sm text-slate-400">{{ days_sorted|length }} dias</span>
          </div>

          {% if days_sorted|length == 0 %}
            <p class="mt-4 text-slate-400">Adicione passeios/roteiro com data para aparecer aqui.</p>
          {% else %}
            <div class="mt-4 grid gap-4">
              {% for d in days_sorted %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <p class="font-semibold text-slate-100">{{ d }}</p>

                <div class="mt-3 grid gap-3">
                  {% for it in by_day[d] %}
                  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
                    <div class="flex items-start justify-between gap-4">
                      <div class="min-w-0">
                        <p class="font-medium truncate text-slate-100">
                          {% if it._meta.get("time") %}{{ it._meta.get("time") }} ‚Ä¢ {% endif %}
                          {{ it.title }}
                          <span class="text-xs text-slate-400">({{ it.category }})</span>
                        </p>

                        <div class="mt-2 flex flex-wrap gap-2 text-sm text-slate-200">
                          {% if it._meta.get("place") %}
                            <span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">üìç {{ it._meta.get("place") }}</span>
                          {% endif %}
                          {% if it._meta.get("agency") %}
                            <span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">üë• {{ it._meta.get("agency") }}</span>
                          {% endif %}
                          {% if it.cost is not none %}
                            <span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>
                          {% endif %}
                          {% if it._meta.get("address") %}
                            <a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition"
                               target="_blank"
                               href="https://www.google.com/maps/search/?api=1&query={{ it._meta.get('address')|urlencode }}">
                              Maps
                            </a>
                          {% endif %}
                          {% if it.url %}
                            <a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition"
                               href="{{ it.url }}" target="_blank">Link</a>
                          {% endif %}
                        </div>

                        {% if it._meta.get("how_to_get") %}
                          <p class="mt-2 text-sm text-slate-200">üöá {{ it._meta.get("how_to_get") }}</p>
                        {% endif %}
                        {% if it.notes %}
                          <p class="mt-2 text-sm text-slate-200 whitespace-pre-wrap">{{ it.notes }}</p>
                        {% endif %}
                      </div>

                      <form method="post" action="/t/{{ trip.token }}/items/{{ it.id }}/delete">
                        <button class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-rose-600 transition">
                          Excluir
                        </button>
                      </form>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Passagens -->
      <div class="tab-panel" id="tab-passagens">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h2 class="text-xl font-semibold">Passagens</h2>
          {% set items = groups.get("flight") or [] %}
          {% if items|length == 0 %}
            <p class="mt-4 text-slate-400">Nenhuma passagem ainda.</p>
          {% else %}
            <div class="mt-4 grid gap-3">
              {% for it in items %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <div class="flex items-start justify-between gap-4">
                  <div class="min-w-0">
                    <p class="font-medium truncate text-slate-100">{{ it.title }}</p>
                    <div class="mt-2 flex flex-wrap gap-2 text-sm text-slate-200">
                      {% if it.item_date %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ it.item_date }}</span>{% endif %}
                      {% if it._meta.get("time") %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ it._meta.get("time") }}</span>{% endif %}
                      {% if it._meta.get("company") %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ it._meta.get("company") }}</span>{% endif %}
                      {% if it._meta.get("duration") %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">dura√ß√£o: {{ it._meta.get("duration") }}</span>{% endif %}
                      {% if it.cost is not none %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>{% endif %}
                      {% if it.url %}<a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition" href="{{ it.url }}" target="_blank">Link</a>{% endif %}
                    </div>
                  </div>
                  <form method="post" action="/t/{{ trip.token }}/items/{{ it.id }}/delete">
                    <button class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-rose-600 transition">Excluir</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Hot√©is -->
      <div class="tab-panel" id="tab-hoteis">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h2 class="text-xl font-semibold">Hot√©is</h2>
          {% set items = groups.get("hotel") or [] %}
          {% if items|length == 0 %}
            <p class="mt-4 text-slate-400">Nenhum hotel ainda.</p>
          {% else %}
            <div class="mt-4 grid gap-3">
              {% for it in items %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <div class="flex items-start justify-between gap-4">
                  <div class="min-w-0">
                    <p class="font-medium truncate text-slate-100">{{ it.title }}</p>
                    <div class="mt-2 flex flex-wrap gap-2 text-sm text-slate-200">
                      {% if it.item_date %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">check-in: {{ it.item_date }}</span>{% endif %}
                      {% if it._meta.get("nights") %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ it._meta.get("nights") }} noites</span>{% endif %}
                      {% if it._meta.get("daily_value") %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">di√°ria: {{ it._meta.get("daily_value") }}</span>{% endif %}
                      {% if it.cost is not none %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>{% endif %}
                      {% if it._meta.get("address") %}
                        <a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition"
                           target="_blank"
                           href="https://www.google.com/maps/search/?api=1&query={{ it._meta.get('address')|urlencode }}">
                          Maps
                        </a>
                      {% endif %}
                      {% if it.url %}<a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition" href="{{ it.url }}" target="_blank">Link</a>{% endif %}
                    </div>
                  </div>
                  <form method="post" action="/t/{{ trip.token }}/items/{{ it.id }}/delete">
                    <button class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-rose-600 transition">Excluir</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Restaurantes -->
      <div class="tab-panel" id="tab-restaurantes">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h2 class="text-xl font-semibold">Restaurantes</h2>
          {% set items = groups.get("restaurant") or [] %}
          {% if items|length == 0 %}
            <p class="mt-4 text-slate-400">Nenhum restaurante ainda.</p>
          {% else %}
            <div class="mt-4 grid gap-3">
              {% for it in items %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <div class="flex items-start justify-between gap-4">
                  <div class="min-w-0">
                    <p class="font-medium truncate text-slate-100">{{ it.title }}</p>
                    <div class="mt-2 flex flex-wrap gap-2 text-sm text-slate-200">
                      {% if it.item_date %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ it.item_date }}</span>{% endif %}
                      {% if it._meta.get("time") %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ it._meta.get("time") }}</span>{% endif %}
                      {% if it.cost is not none %}<span class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700">{{ trip.currency }} {{ cents_to_money(it.cost) }}</span>{% endif %}
                      {% if it._meta.get("address") %}
                        <a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition"
                           target="_blank"
                           href="https://www.google.com/maps/search/?api=1&query={{ it._meta.get('address')|urlencode }}">
                          Maps
                        </a>
                      {% endif %}
                      {% if it.url %}<a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition" href="{{ it.url }}" target="_blank">Link</a>{% endif %}
                    </div>
                    {% if it.notes %}
                      <p class="mt-2 text-sm text-slate-200 whitespace-pre-wrap">{{ it.notes }}</p>
                    {% endif %}
                  </div>
                  <form method="post" action="/t/{{ trip.token }}/items/{{ it.id }}/delete">
                    <button class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-rose-600 transition">Excluir</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Links -->
      <div class="tab-panel" id="tab-links">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h2 class="text-xl font-semibold">Links</h2>
          {% set items = groups.get("reference") or [] %}
          {% if items|length == 0 %}
            <p class="mt-4 text-slate-400">Nenhum link ainda.</p>
          {% else %}
            <div class="mt-4 grid gap-3">
              {% for it in items %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <div class="flex items-start justify-between gap-4">
                  <div class="min-w-0">
                    <p class="font-medium truncate text-slate-100">{{ it.title }}</p>
                    <div class="mt-2 flex flex-wrap gap-2 text-sm text-slate-200">
                      {% if it.url %}<a class="px-2 py-1 rounded-xl bg-slate-900 border border-slate-700 hover:bg-slate-800 transition" href="{{ it.url }}" target="_blank">Abrir</a>{% endif %}
                    </div>
                    {% if it.notes %}
                      <p class="mt-2 text-sm text-slate-200 whitespace-pre-wrap">{{ it.notes }}</p>
                    {% endif %}
                  </div>
                  <form method="post" action="/t/{{ trip.token }}/items/{{ it.id }}/delete">
                    <button class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-rose-600 transition">Excluir</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Notas -->
      <div class="tab-panel" id="tab-notas">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h2 class="text-xl font-semibold">Anota√ß√µes</h2>
          {% set items = groups.get("notes") or [] %}
          {% if items|length == 0 %}
            <p class="mt-4 text-slate-400">Sem anota√ß√µes ainda.</p>
          {% else %}
            <div class="mt-4 grid gap-3">
              {% for it in items %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <div class="flex items-start justify-between gap-4">
                  <div class="min-w-0">
                    <p class="text-sm text-slate-400">{{ it.created_at }}</p>
                    {% if it.notes %}
                      <p class="mt-2 text-sm text-slate-200 whitespace-pre-wrap">{{ it.notes }}</p>
                    {% endif %}
                  </div>
                  <form method="post" action="/t/{{ trip.token }}/items/{{ it.id }}/delete">
                    <button class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-rose-600 transition">Excluir</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Custos (lista no painel direito tamb√©m) -->
      <div class="tab-panel" id="tab-custos">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/30 p-6">
          <h2 class="text-xl font-semibold">Custos</h2>
          <div class="mt-4 grid md:grid-cols-2 gap-3">
            {% for cat, label in category_label.items() %}
              {% if total_by_cat.get(cat) %}
              <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
                <p class="text-sm text-slate-400">{{ label }}</p>
                <p class="text-lg font-semibold text-slate-100">{{ trip.currency }} {{ cents_to_money(total_by_cat.get(cat)) }}</p>
              </div>
              {% endif %}
            {% endfor %}
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4">
              <p class="text-sm text-slate-400">Total</p>
              <p class="text-lg font-semibold text-slate-100">{{ trip.currency }} {{ cents_to_money(total_all) }}</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<style>
  .tab-btn{
    white-space:nowrap;
    padding: .6rem 1rem;
    border-radius: 9999px;
    border: 1px solid rgb(30 41 59);
    background: rgb(2 6 23);
    color: rgb(226 232 240);
    transition: .15s;
    font-weight: 600;
    font-size: .9rem;
  }
  .tab-btn:hover{ background: rgb(15 23 42); }
  .tab-btn.active{
    border-color: rgb(99 102 241);
    box-shadow: 0 0 0 2px rgba(99,102,241,.25);
  }
  .tab-panel{ display:none; }
  .tab-panel.active{ display:block; }
</style>

<script>
  (function() {
    const btns = Array.from(document.querySelectorAll('.tab-btn'));
    const panels = Array.from(document.querySelectorAll('.tab-panel'));

    function activate(tabId){
      btns.forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
      panels.forEach(p => p.classList.toggle('active', p.id === tabId));
      localStorage.setItem('tripPlannerTab', tabId);
      // sobe a tela um pouco no mobile para parecer "trocou de p√°gina"
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    const saved = localStorage.getItem('tripPlannerTab');
    const first = saved && document.getElementById(saved) ? saved : 'tab-roteiro';
    activate(first);

    btns.forEach(b => b.addEventListener('click', () => activate(b.dataset.tab)));
  })();
</script>

{% endblock %}
